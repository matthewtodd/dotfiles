#!/bin/bash

set -euxo pipefail

export DIR=$(cd `dirname $0`; pwd)

mkdir -p ${HOME}/.config
mkdir -p ${HOME}/.local

ln -sfh ${DIR}/bin ${HOME}/.local/bin
ln -sfh ${DIR}/etc/fish ${HOME}/.config/fish
ln -sfh ${DIR}/etc/git ${HOME}/.config/git
ln -sfh ${DIR}/etc/nvim ${HOME}/.config/nvim
ln -sfh ${DIR}/etc/tmux ${HOME}/.config/tmux
ln -sfh ${DIR}/etc/zsh ${HOME}/.config/zsh

if [ "${DIR}/share/zshenv" != "$(readlink /etc/zshenv)" ]; then
  sudo ln -sfh ${DIR}/share/zshenv /etc/zshenv
fi

# I would like to just symlink all of etc into ~/.config, but some programs
# don't use their config directories in version-controllable ways. They should
# perhaps look to XDG_DATA_HOME instead!
#
# The offenders:
# - gcloud writes auth tokens and python virtualenvs.
#   So using .gitignore means I'm one `git clean` away from logging myself out.
#   Hypothetically speaking.
#
# But if a new program starts writing into ~/.config, I want to see it here so
# I can consider adding it to version control, hence this `find` call.
#
set +x
find ${HOME}/.config -type d -depth 1 \
  -not -name gcloud \
  -exec echo $(tput setaf 3)Consider adding '{}' to version control.$(tput sgr0) \;
set -x

which brew \
  || /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install.sh)"

brew update --verbose

brew bundle check --verbose --file=${DIR}/share/Brewfile \
  || brew bundle install --verbose --file=${DIR}/share/Brewfile --no-lock

brew completions link

brew bundle cleanup --force --file=${DIR}/share/Brewfile

brew upgrade --verbose
brew cleanup --verbose

grep -q /usr/local/bin/fish /etc/shells \
  || sudo bash -c 'echo /usr/local/bin/fish >> /etc/shells'

# https://stackoverflow.com/a/41553295
dscl . -read ~ UserShell | grep -q /usr/local/bin/fish \
  || chsh -s /usr/local/bin/fish

gcloud components install beta
pulumi plugin install resource gcp 1.9.0
pulumi plugin install resource aws 1.18.0

fish -c "git submodule update --init --remote"
fish -c "nvim -c 'helptags ALL' -c TSUpdateSync -c quit"
fish -c "npm update -g typescript typescript-language-server vscode-langservers-extracted"

# https://github.com/Hammerspoon/hammerspoon/pull/582
fish -c "defaults write org.hammerspoon.Hammerspoon MJConfigFile ${DIR}/etc/hammerspoon/init.lua"

swift ${DIR}/libexec/dynamic_desktop.swift
swift ${DIR}/libexec/terminal_profiles.swift
