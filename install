#!/bin/bash

set -euo pipefail

DIR=$(cd "$(dirname "$0")"; pwd)

mkdir -p "${HOME}/.config"
mkdir -p "${HOME}/.local"

ln -sfh "${DIR}/bin" "${HOME}/.local/bin"
ln -sfh "${DIR}/etc/atuin" "${HOME}/.config/atuin"
ln -sfh "${DIR}/etc/fish" "${HOME}/.config/fish"
ln -sfh "${DIR}/etc/gh" "${HOME}/.config/gh"
ln -sfh "${DIR}/etc/git" "${HOME}/.config/git"
ln -sfh "${DIR}/etc/nvim" "${HOME}/.config/nvim"
ln -sfh "${DIR}/etc/tmux" "${HOME}/.config/tmux"

# I would like to just symlink all of etc into ~/.config, but some programs
# don't use their config directories in version-controllable ways. They should
# perhaps look to XDG_DATA_HOME instead!
#
# The offenders:
# - npm uses update-notifier, which uses configstore to track update checks.
#   https://www.npmjs.com/package/update-notifier
#   https://github.com/yeoman/update-notifier/blob/3046d0f61a57f8270291b6ab271f8a12df8421a6/update-notifier.js#L65-L70
#   https://www.npmjs.com/package/configstore
# - op stores volatile state as well as a daemon socket.
#
# But if a new program starts writing into ~/.config, I want to see it here so
# I can consider adding it to version control, hence this `find` call.
#
find "${HOME}/.config" -type d -depth 1 \
  -not -name configstore \
  -not -name op \
  -exec echo "$(tput setaf 3)Consider adding '{}' to version control.$(tput sgr0)" \;

which brew \
  || /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install.sh)"

brew update --verbose
brew bundle install --cleanup --verbose --file="${DIR}/opt/Brewfile"
brew cleanup --verbose
brew completions link

grep -q /usr/local/bin/fish /etc/shells \
  || sudo bash -c 'echo /usr/local/bin/fish >> /etc/shells'

# https://stackoverflow.com/a/41553295
dscl . -read ~ UserShell | grep -q /usr/local/bin/fish \
  || chsh -s /usr/local/bin/fish

fish -c "git submodule update --init --remote"
fish -c "nvim -c 'helptags ALL' -c TSUpdateSync -c quit"
fish -c "cd ${DIR}/opt && bundle update"
fish -c "cd ${DIR}/opt && npm update"

# https://github.com/Hammerspoon/hammerspoon/pull/582
fish -c "defaults write org.hammerspoon.Hammerspoon MJConfigFile ${DIR}/etc/hammerspoon/init.lua"

# Failing 2023-09-20 with "JIT session error: Symbols not found: [ _$s7SwiftUI13ImageRendererC7contentACyxGx_tcfC, ..."
# I suspect this is because Xcode 15 (which was just installed) lacks the macOS 13 SDK?
# On clicking in, there's no immediate way I can find to install it.
# So I can try to reinstall Xcode 14 or just wait for macOS 14 on this machine.
# I think I will wait, since I don't really need to change this wallpaper.
# swift "${DIR}/libexec/dynamic_desktop.swift" "${HOME}/Pictures/Solarized.heic"
swift "${DIR}/libexec/set_desktop_image.swift" "${HOME}/Pictures/Solarized.heic"
swift "${DIR}/libexec/terminal_profiles.swift"

# Why not? This could be fun.
open raycast://confetti
