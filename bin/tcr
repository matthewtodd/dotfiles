#!/bin/sh

set -euo pipefail

tput reset

emoji=("ğŸ»" "ğŸ¦–" "ğŸŒ¯" "ğŸ•" "ğŸ¸" "ğŸš€" "ğŸ¦" "ğŸ©" "ğŸ¦")
git commit -m "${emoji[$RANDOM % ${#emoji[@]} ]} $(date '+%A, %B %e')" --allow-empty
commit=$(git rev-parse HEAD)

# Why not just use fswatch's own looping?
# Because we don't want to trigger another cycle on revert.
# It's helpful to leave the bad diff and the test failures on screen.
running=1; trap "running=0" INT

while [ $running -eq 1 ]; do
  fswatch --one-event --latency 0.1 $(git ls-files) | xargs bash -c "
    tput reset

    echo \"\$(tput setaf 6)git --no-pager diff\$(tput sgr0)\"
    git --no-pager diff
    echo

    git test

    if [ \$? -eq 0 ]; then
      git add --all
      git commit --fixup $commit --allow-empty --quiet
    else
      git reset --hard --quiet
      sleep 1
    fi
  "
done
