#!/usr/bin/env ruby

require 'rubygems'

def open_in_editor(spec)
  puts "Opening #{spec.full_name}"
  Dir.chdir(spec.full_gem_path) do
    exec ENV['GEM_OPEN_EDITOR'] || ENV['EDITOR']
  end
end

def prompt_to_select(specs)
  specs.each_with_index do |spec, index|
    puts '%2d. %s' % [index.succ, spec.full_name]
  end

  puts
  $stdout.write "[#{specs.last.full_name}] ? "
  $stdout.flush

  choice = begin
    gets.to_s.strip.to_i
  rescue Interrupt
    puts
    puts 'Goodbye.'
    exit
  end

  case choice
  when 0
    specs.last
  when (1..specs.length)
    specs[choice.pred]
  else
    prompt_to_select(specs)
  end
end

specs = Gem.source_index.find_name /^#{ARGV.shift}/

open_in_editor case specs.length
               when 0
                 prompt_to_select(Gem.source_index.gems)
               when 1
                 specs.first
               else
                 prompt_to_select(specs)
               end
