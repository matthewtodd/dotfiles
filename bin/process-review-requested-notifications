#!/bin/sh

set -euo pipefail

export XDG_CONFIG_HOME=${XDG_CONFIG_HOME:-${HOME}/.config}

# Fetch the PR URLs for any unread Github review request notifications.
# https://docs.github.com/en/rest/reference/activity#list-notifications-for-the-authenticated-user
#
# It would be lovely to issue a single GraphQL request here, instead of passing
# URLs along for N+1 calls, but as of this writing there's no notifications
# support in Github's GraphQL endpoint.
# https://github.community/t/get-notification-list-via-graphql-api/13836
NOTIFICATIONS=$(
  /usr/local/bin/gh api --cache=1h /notifications --jq='.[]
    | select(.subject.type == "PullRequest")
    | { pr: .subject.url, thread: .url }'
)

THINGS_JSON_URLS=$(
  echo ${NOTIFICATIONS} | /usr/local/bin/jq -r '.pr' | while read url; do
    # This jq script maps Github PR json into Things to-do json.
    # https://docs.github.com/en/rest/reference/pulls
    # https://culturedcode.com/things/support/articles/2803573/
    /usr/local/bin/gh api --cache=1h $url --jq='select(.state == "open") | {
      type: "to-do",
      attributes: {
        title: ("[" + .user.login + "] " + .title),
        notes: .html_url,
        when: "today",
        list: "Code Review",
      }
    }' | \

    # This jq script morphs its input into a Things json URL.
    # https://culturedcode.com/things/support/articles/2803573/
    /usr/local/bin/jq -sr '("things:///json?data=" + @uri)' | \

    sed "s/\'/\\\'/g"
  done
)

# Load tasks into Things.
echo ${THINGS_JSON_URLS} | xargs -n1 open -u

# Mark Github notifications as read, so we won't see them next time.
# https://docs.github.com/en/rest/reference/activity#mark-a-thread-as-read
echo ${NOTIFICATIONS} | /usr/local/bin/jq -r '.thread' | xargs -n1 /usr/local/bin/gh api -X PATCH
