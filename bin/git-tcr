#!/bin/sh

set -euo pipefail

running=1; trap "running=0" INT

tput reset

while [ $running -eq 1 ]; do
  fswatch -1r -l 0.1 $(git ls-files) | xargs bash -c '
    run() {
      echo "$(tput setaf 6)$*$(tput sgr0)"
      eval $*
      result=$?
      echo
      return $result
    }

    tput reset

    run git --no-pager diff

    while IFS= read -r command; do
      if ! run $command; then
        git reset --hard --quiet
        sleep 5
        exit
      fi
    done < <(git --no-pager config --get-all tcr.command)

    git commit -am working --allow-empty --quiet
  '
done
